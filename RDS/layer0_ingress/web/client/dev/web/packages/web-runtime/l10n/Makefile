# On OSX the PATH variable isn't exported unless "SHELL" is also set, see: http://stackoverflow.com/a/25506676
SHELL = /bin/bash
NODE_MODULES = ../../../node_modules
NODE_BINDIR = $(NODE_MODULES)/.bin
export PATH := $(NODE_BINDIR):$(PATH)

# Where to find apps (it can be multiple paths).
APPS = $(shell find ../.. -maxdepth 1 -name 'web-app-*')

# Where to find core folder
CORE = ..

# List of all files to extract
INPUT_FILES = $(CORE) $(APPS)

# Where to write the files generated by this makefile.
OUTPUT_DIR = .

# Core Template file
TEMPLATE_FILE = ./template.pot

# Available locales for the app.
LOCALES = de fr es it cs gl

# Name of the generated .po files for each available locale.
LOCALE_FILES ?= $(foreach app,$(APPS),$(patsubst %,$(app)/l10n/locale/%/LC_MESSAGES/app.po,$(LOCALES))) $(patsubst %,./locale/%/LC_MESSAGES/app.po,$(LOCALES))

.PHONY: clean
clean:
	rm -f $(foreach app,$(APPS),$(app)/l10n/template.pot);
	rm -f $(TEMPLATE_FILE);
	rm -rf $(foreach app,$(APPS),$(app)/l10n/locale);
	rm -rf locale;

.PHONY: extract
extract: $(TEMPLATE_FILE)

# Create a main .pot template, then generate .po files for each available language.
# Thanks to Systematic: https://github.com/Polyconseil/systematic/blob/866d5a/mk/main.mk#L167-L183
$(TEMPLATE_FILE):
# Extract gettext strings from each apps templates files and create a POT dictionary template.
# Generate .po files for each available language.
	@for app in $(INPUT_FILES); \
	do \
		if [ $$app = '../src' ]; then \
			export OUT_DIR=.; \
		else \
			export OUT_DIR=$$app/l10n; \
		fi; \
		mkdir -p $$OUT_DIR; \
		export GETTEXT_APP_SOURCES=`find $$app/src -name '*.vue' -o -name '*.js'`; \
		node $(NODE_MODULES)/easygettext/src/extract-cli.js --attribute v-translate --output $$OUT_DIR/template.pot $$GETTEXT_APP_SOURCES; \
	done;

.PHONY: translations
translations: $(OUTPUT_DIR)/translations.json

# Generate translations.json file from all available apps .pot templates.
.PHONY: $(OUTPUT_DIR)/translations.json
$(OUTPUT_DIR)/translations.json:
	@for app in $(INPUT_FILES); \
	do \
		if [ $$app = '../src' ]; then \
			export OUT_DIR=.; \
		else \
			export OUT_DIR=$$app/l10n; \
		fi; \
		mkdir -p $$OUT_DIR; \
		gettext-compile --output $$OUT_DIR/translations.json $(patsubst %,$$OUT_DIR/locale/%/LC_MESSAGES/app.po,$(LOCALES)); \
	done; \

.PHONY: push
push:
	@for app in $(INPUT_FILES); \
	do \
		if [ $$app = '../src' ]; then \
			export OUT_DIR=.; \
		else \
			export OUT_DIR=$$app/l10n; \
		fi; \
		cd $$OUT_DIR; \
		tx -d push -s --no-interactive; \
	done; \

.PHONY: pull
pull:
	@for app in $(INPUT_FILES); \
	do \
		if [ $$app = '../src' ]; then \
			export OUT_DIR=.; \
		else \
			export OUT_DIR=$$app/l10n; \
		fi; \
		cd $$OUT_DIR; \
		tx -d pull -a; \
	done; \
